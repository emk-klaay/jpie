#!/usr/bin/env bash
# Setup script for JPie development environment
# This script installs and configures Git hooks for code quality enforcement

set -e

echo "ğŸš€ Setting up JPie development environment..."

# Check if overcommit is installed globally
if ! command -v overcommit &> /dev/null; then
    echo "ğŸ“¦ Installing overcommit globally..."
    gem install overcommit
else
    echo "âœ… Overcommit already installed"
fi

# Install bundle dependencies
echo "ğŸ“¦ Installing bundle dependencies..."
bundle install

# Install Git hooks
echo "ğŸ”§ Installing Git hooks..."
overcommit --install

# Sign the configuration
echo "ğŸ” Signing overcommit configuration..."
overcommit --sign

# Test the setup
echo "ğŸ§ª Testing hook setup..."
if overcommit --run pre-commit; then
    echo "âœ… Pre-commit hooks working correctly"
else
    echo "âŒ Pre-commit hooks failed - please check your setup"
    exit 1
fi

if overcommit --run pre-push; then
    echo "âœ… Pre-push hooks working correctly"
else
    echo "âŒ Pre-push hooks failed - please check your setup"
    exit 1
fi

echo ""
echo "ğŸ‰ Development environment setup complete!"
echo ""
echo "The following quality checks will now run automatically:"
echo "  â€¢ RuboCop (code style) - on every commit"
echo "  â€¢ RSpec (tests) - on every push"
echo "  â€¢ Trailing whitespace check - on every commit"
echo "  â€¢ Merge conflict detection - on every commit"
echo ""
echo "You can run manual checks with:"
echo "  bundle exec rubocop -A    # Fix code style issues"
echo "  bundle exec rspec         # Run tests"
echo "  overcommit --run pre-commit  # Test pre-commit hooks"
echo "  overcommit --run pre-push    # Test pre-push hooks"
echo ""
echo "Happy coding! ğŸ¯"